<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administraci√≥n de Patrones - Invoice Intelligence</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
</head>

<body>
    <div class="dashboard">
        <header>
            <h1>‚öôÔ∏è Administraci√≥n de Patrones</h1>
            <div class="user-profile" style="display: flex; gap: 1rem; align-items: center;">
                <button class="upload-btn" onclick="window.location.href='/frontend/index.html'"
                    style="background: rgba(255,255,255,0.1); color: var(--text-main); border: 1px solid var(--glass-border);">
                    ‚Üê Volver al Dashboard
                </button>
            </div>
        </header>

        <div class="grid">
            <!-- Selector de Proveedor -->
            <div class="card" style="grid-column: 1 / 4;">
                <h2>Seleccionar Proveedor</h2>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <select id="providerSelect" onchange="loadProvider()"
                        style="flex: 1; padding: 0.75rem; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: var(--text-main); border-radius: 0.5rem; font-size: 1rem;">
                        <option value="" style="background: #1e293b; color: #e2e8f0;">Selecciona un proveedor...
                        </option>
                    </select>
                    <button class="upload-btn" onclick="addNewProvider()">+ Nuevo Proveedor</button>
                    <button class="upload-btn" onclick="savePatterns()"
                        style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">üíæ Guardar
                        Cambios</button>
                </div>
                <div id="saveStatus" style="margin-top: 1rem; font-size: 0.85rem;"></div>
            </div>

            <!-- Editor de Patrones -->
            <div class="card" style="grid-column: 1 / 3; display: none;" id="editorCard">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 id="providerTitle">Editor de Patrones</h2>
                    <button onclick="deleteProvider()"
                        style="background: rgba(239, 68, 68, 0.2); border: 1px solid #ef4444; color: #fca5a5; cursor: pointer; padding: 0.5rem 1rem; border-radius: 0.5rem;">üóëÔ∏è
                        Eliminar Proveedor</button>
                </div>

                <div style="display: grid; gap: 1.5rem;">
                    <!-- Informaci√≥n B√°sica -->
                    <div>
                        <label
                            style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.9rem;">Nombre
                            del Proveedor:</label>
                        <input type="text" id="providerName" placeholder="Ej: Mercadona"
                            style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: var(--text-main); border-radius: 0.5rem;">
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label
                                style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.9rem;">Nombre
                                en Factura:</label>
                            <input type="text" id="vendorName" placeholder="Ej: Mercadona S.A."
                                style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: var(--text-main); border-radius: 0.5rem;">
                        </div>
                        <div>
                            <label
                                style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.9rem;">Categor√≠a:</label>
                            <select id="categorySelect"
                                style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: var(--text-main); border-radius: 0.5rem;">
                                <option value="Telecom" style="background: #1e293b; color: #e2e8f0;">Telecomunicaciones
                                </option>
                                <option value="Electricity" style="background: #1e293b; color: #e2e8f0;">Electricidad
                                </option>
                                <option value="Gas" style="background: #1e293b; color: #e2e8f0;">Gas</option>
                                <option value="Water" style="background: #1e293b; color: #e2e8f0;">Agua</option>
                                <option value="Food" style="background: #1e293b; color: #e2e8f0;">Alimentaci√≥n</option>
                                <option value="Maintenance" style="background: #1e293b; color: #e2e8f0;">Mantenimiento
                                </option>
                                <option value="Other" style="background: #1e293b; color: #e2e8f0;">Otros</option>
                            </select>
                        </div>
                    </div>

                    <!-- Patrones Regex -->
                    <div>
                        <h3 style="color: var(--text-main); margin-bottom: 1rem;">Patrones de Extracci√≥n (Regex)</h3>

                        <div style="margin-bottom: 1rem;">
                            <label
                                style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.9rem;">üî¢
                                N√∫mero de Factura (uno por l√≠nea):</label>
                            <textarea id="invoiceNumberPatterns" rows="3"
                                placeholder='Ej: FACTURA SIMPLIFICADA[:\s]+(\d{4}-\d{3}-\d{6})'
                                style="width: 100%; padding: 0.75rem; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: #6ee7b7; border-radius: 0.5rem; font-family: 'Courier New', monospace; font-size: 0.85rem;"></textarea>
                        </div>

                        <div style="margin-bottom: 1rem;">
                            <label
                                style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.9rem;">üìÖ
                                Fecha (uno por l√≠nea):</label>
                            <textarea id="datePatterns" rows="3" placeholder='Ej: (\d{2})/(\d{2})/(\d{4})'
                                style="width: 100%; padding: 0.75rem; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: #6ee7b7; border-radius: 0.5rem; font-family: 'Courier New', monospace; font-size: 0.85rem;"></textarea>
                        </div>

                        <div style="margin-bottom: 1rem;">
                            <label
                                style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.9rem;">üè¢
                                Proveedor (uno por l√≠nea):</label>
                            <textarea id="vendorPatterns" rows="2" placeholder='Ej: MERCADONA[,\s]+S\.?A\.?'
                                style="width: 100%; padding: 0.75rem; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: #6ee7b7; border-radius: 0.5rem; font-family: 'Courier New', monospace; font-size: 0.85rem;"></textarea>
                        </div>

                        <div style="margin-bottom: 1rem;">
                            <label
                                style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.9rem;">üÜî
                                NIF/CIF (Prioridad M√°xima - uno por l√≠nea):</label>
                            <textarea id="nifPatterns" rows="2" placeholder='Ej: 39182489B'
                                style="width: 100%; padding: 0.75rem; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: #fbbf24; border-radius: 0.5rem; font-family: 'Courier New', monospace; font-size: 0.85rem;"></textarea>
                        </div>

                        <div style="margin-bottom: 1rem;">
                            <label
                                style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.9rem;">üí∞
                                Importe Total (uno por l√≠nea):</label>
                            <textarea id="totalAmountPatterns" rows="2" placeholder='Ej: TOTAL\s+\(‚Ç¨\)\s+(\d+[.,]\d{2})'
                                style="width: 100%; padding: 0.75rem; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: #6ee7b7; border-radius: 0.5rem; font-family: 'Courier New', monospace; font-size: 0.85rem;"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ayuda y Documentaci√≥n -->
            <div class="card" style="grid-column: 3 / 4; display: none;" id="helpCard">
                <h2>üìö Gu√≠a R√°pida</h2>
                <div style="font-size: 0.85rem; color: var(--text-muted); line-height: 1.6;">
                    <h3 style="color: var(--text-main); font-size: 0.95rem; margin-top: 1rem;">Regex B√°sico:</h3>
                    <ul style="margin-left: 1rem;">
                        <li><code>\d</code> = cualquier d√≠gito (0-9)</li>
                        <li><code>\d{2}</code> = exactamente 2 d√≠gitos</li>
                        <li><code>\d+</code> = uno o m√°s d√≠gitos</li>
                        <li><code>[.,]</code> = punto o coma</li>
                        <li><code>\s+</code> = uno o m√°s espacios</li>
                        <li><code>[:\s]+</code> = dos puntos o espacios</li>
                        <li><code>(...)</code> = grupo a capturar</li>
                    </ul>

                    <h3 style="color: var(--text-main); font-size: 0.95rem; margin-top: 1.5rem;">Ejemplos:</h3>
                    <div
                        style="background: rgba(0,0,0,0.2); padding: 0.75rem; border-radius: 0.5rem; margin-top: 0.5rem;">
                        <strong>N√∫mero:</strong><br>
                        <code style="color: #6ee7b7;">FACTURA[:\s]+([0-9-]+)</code>
                    </div>
                    <div
                        style="background: rgba(0,0,0,0.2); padding: 0.75rem; border-radius: 0.5rem; margin-top: 0.5rem;">
                        <strong>Fecha DD/MM/YYYY:</strong><br>
                        <code style="color: #6ee7b7;">(\d{2})/(\d{2})/(\d{4})</code>
                    </div>

                    <p
                        style="margin-top: 1.5rem; padding: 0.75rem; background: rgba(34, 211, 153, 0.1); border-left: 3px solid #10b981; border-radius: 0.5rem;">
                        üí° <strong>Tip:</strong> Usa la tarjeta de "Texto Extra√≠do" en el dashboard principal para ver
                        el texto real y crear tus regex.
                    </p>
                </div>
            </div>

            <!-- Configuraci√≥n de IA -->
            <div class="card" style="grid-column: 1 / 4; margin-top: 1rem; border: 1px solid rgba(139, 92, 246, 0.3);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2>ü§ñ Configuraci√≥n de Inteligencia Artificial</h2>
                    <button class="upload-btn" onclick="saveAISettings()"
                        style="background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);">üíæ Guardar Configuraci√≥n
                        IA</button>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 2rem;">
                    <div>
                        <label
                            style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.9rem;">Proveedor
                            de IA:</label>
                        <select id="aiProviderSelect" onchange="toggleAIFields()"
                            style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: var(--text-main); border-radius: 0.5rem;">
                            <option value="ollama" style="background: #1e293b; color: #e2e8f0;">Ollama (Local -
                                Privacidad M√°xima)</option>
                            <option value="gemini" style="background: #1e293b; color: #e2e8f0;">Google Gemini (P√∫blico -
                                Mayor Precisi√≥n)</option>
                            <option value="openai" style="background: #1e293b; color: #e2e8f0;">OpenAI ChatGPT (P√∫blico
                                - Est√°ndar)</option>
                        </select>
                        <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem;">
                            Selecciona 'Ollama' para procesamiento local o un proveedor p√∫blico para mayor fiabilidad en
                            la extracci√≥n.
                        </p>
                    </div>

                    <div id="aiKeysContainer" style="display: none; grid-template-columns: 1fr; gap: 1rem;">
                        <div id="geminiKeyBox" style="display: none;">
                            <label
                                style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.9rem;">Gemini
                                API Key:</label>
                            <input type="password" id="geminiApiKey" placeholder="Tu clave de API de Google..."
                                style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: var(--text-main); border-radius: 0.5rem;">
                        </div>
                        <div id="openaiKeyBox" style="display: none;">
                            <label
                                style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.9rem;">OpenAI
                                API Key:</label>
                            <input type="password" id="openaiApiKey" placeholder="Tu clave de API de OpenAI..."
                                style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: var(--text-main); border-radius: 0.5rem;">
                        </div>
                    </div>
                </div>
                <div id="aiSaveStatus" style="margin-top: 1rem; font-size: 0.85rem;"></div>
            </div>

            <!-- Dashboard de Logs de Extracci√≥n -->
            <div class="card" style="grid-column: 1 / 4; margin-top: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2>üìù Registro de Identificaci√≥n (Troubleshooting)</h2>
                    <button class="upload-btn" onclick="loadLogs()" style="padding: 0.5rem 1rem;">üîÑ Refrescar
                        Logs</button>
                </div>
                <div id="logsContainer"
                    style="max-height: 400px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 0.5rem; border: 1px solid var(--glass-border);">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                        <thead style="background: rgba(255,255,255,0.05); position: sticky; top: 0;">
                            <tr>
                                <th style="padding: 1rem; text-align: left;">Archivo</th>
                                <th style="padding: 1rem; text-align: left;">Resultado IA</th>
                                <th style="padding: 1rem; text-align: left;">Scoring de Proveedores</th>
                                <th style="padding: 1rem; text-align: left;">Timestamp</th>
                            </tr>
                        </thead>
                        <tbody id="logsBody">
                            <tr>
                                <td colspan="4" style="padding: 2rem; text-align: center; color: var(--text-muted);">
                                    Pulsa refrescar para ver los logs...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allPatterns = null;
        let currentProviderIndex = -1;

        // Cargar patrones al iniciar
        async function loadPatterns() {
            try {
                const response = await fetch('/admin/patterns');
                const data = await response.json();
                if (data.status === 'success') {
                    allPatterns = data.patterns;
                    populateProviderSelect();
                }
            } catch (err) {
                alert('Error cargando patrones: ' + err.message);
            }
        }

        function populateProviderSelect() {
            const select = document.getElementById('providerSelect');
            select.innerHTML = '<option value="" style="background: #1e293b; color: #e2e8f0;">Selecciona un proveedor...</option>';
            allPatterns.providers.forEach((provider, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${provider.name} (${provider.category})`;
                option.style.background = '#1e293b';
                option.style.color = '#e2e8f0';
                select.appendChild(option);
            });
        }

        function loadProvider() {
            const select = document.getElementById('providerSelect');
            const index = parseInt(select.value);

            if (isNaN(index)) {
                document.getElementById('editorCard').style.display = 'none';
                document.getElementById('helpCard').style.display = 'none';
                return;
            }

            currentProviderIndex = index;
            const provider = allPatterns.providers[index];

            // Mostrar editor y ayuda
            document.getElementById('editorCard').style.display = 'block';
            document.getElementById('helpCard').style.display = 'block';

            // Rellenar campos
            document.getElementById('providerTitle').textContent = `Editor: ${provider.name}`;
            document.getElementById('providerName').value = provider.name;
            document.getElementById('vendorName').value = provider.vendor_name;
            document.getElementById('categorySelect').value = provider.category;

            // Rellenar patrones
            document.getElementById('invoiceNumberPatterns').value = provider.patterns.invoice_number.join('\n');
            document.getElementById('datePatterns').value = provider.patterns.date.join('\n');
            document.getElementById('vendorPatterns').value = provider.patterns.vendor.join('\n');
            document.getElementById('nifPatterns').value = (provider.patterns.nif || []).join('\n');
            document.getElementById('totalAmountPatterns').value = provider.patterns.total_amount.join('\n');
        }

        function addNewProvider() {
            const newProvider = {
                name: "Nuevo Proveedor",
                vendor_name: "Nuevo Proveedor",
                category: "Other",
                patterns: {
                    invoice_number: [""],
                    date: ["(\\d{2})/(\\d{2})/(\\d{4})"],
                    vendor: [""],
                    nif: [""],
                    total_amount: [""]
                }
            };
            allPatterns.providers.push(newProvider);
            populateProviderSelect();
            document.getElementById('providerSelect').value = allPatterns.providers.length - 1;
            loadProvider();
        }

        function deleteProvider() {
            if (currentProviderIndex === -1) return;
            if (!confirm('¬øSeguro que quieres eliminar este proveedor?')) return;

            allPatterns.providers.splice(currentProviderIndex, 1);
            populateProviderSelect();
            document.getElementById('editorCard').style.display = 'none';
            document.getElementById('helpCard').style.display = 'none';
            currentProviderIndex = -1;
        }

        async function savePatterns() {
            if (currentProviderIndex !== -1) {
                // Guardar cambios del proveedor actual
                const provider = allPatterns.providers[currentProviderIndex];
                provider.name = document.getElementById('providerName').value;
                provider.vendor_name = document.getElementById('vendorName').value;
                provider.category = document.getElementById('categorySelect').value;
                provider.patterns.invoice_number = document.getElementById('invoiceNumberPatterns').value.split('\n').filter(l => l.trim());
                provider.patterns.date = document.getElementById('datePatterns').value.split('\n').filter(l => l.trim());
                provider.patterns.vendor = document.getElementById('vendorPatterns').value.split('\n').filter(l => l.trim());
                provider.patterns.nif = document.getElementById('nifPatterns').value.split('\n').filter(l => l.trim());
                provider.patterns.total_amount = document.getElementById('totalAmountPatterns').value.split('\n').filter(l => l.trim());
            }

            // Enviar al servidor
            const statusDiv = document.getElementById('saveStatus');
            statusDiv.innerHTML = '‚è≥ Guardando...';
            statusDiv.style.color = '#818cf8';

            try {
                const response = await fetch('/admin/patterns', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(allPatterns)
                });
                const data = await response.json();

                if (data.status === 'success') {
                    statusDiv.innerHTML = '‚úÖ Guardado correctamente. Los cambios se aplicar√°n en la pr√≥xima factura subida.';
                    statusDiv.style.color = '#34d399';
                    populateProviderSelect();
                    setTimeout(() => statusDiv.innerHTML = '', 5000);
                } else {
                    statusDiv.innerHTML = '‚ùå Error: ' + data.message;
                    statusDiv.style.color = '#f87171';
                }
            } catch (err) {
                statusDiv.innerHTML = '‚ùå Error al guardar: ' + err.message;
                statusDiv.style.color = '#f87171';
            }
        }

        async function loadLogs() {
            try {
                const response = await fetch('/admin/logs');
                const data = await response.json();
                if (data.status === 'success') {
                    const tbody = document.getElementById('logsBody');
                    tbody.innerHTML = data.logs.map(log => {
                        const date = new Date(log.timestamp).toLocaleString();
                        const scores = log.matching_scores.map(s =>
                            `<div style="margin-bottom:4px;"><strong>${s.provider}</strong>: üèÜ ${s.score} pts <br><small style="color:#6ee7b7">${s.matches.join(', ')}</small></div>`
                        ).join('');

                        return `
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                            <td style="padding: 1rem; vertical-align: top;">${log.file_name}</td>
                            <td style="padding: 1rem; vertical-align: top;"><pre style="font-size:0.7rem; color:#818cf8;">${JSON.stringify(log.final_json, null, 2)}</pre></td>
                            <td style="padding: 1rem; vertical-align: top;">${scores}</td>
                            <td style="padding: 1rem; vertical-align: top;">${date}</td>
                        </tr>
                        `;
                    }).join('');
                }
            } catch (err) {
                console.error("Error cargando logs:", err);
            }
        }

        // --- AI SETTINGS ---

        async function loadAISettings() {
            try {
                const response = await fetch('/api/settings');
                const data = await response.json();
                if (data.status === 'success') {
                    const s = data.settings;
                    document.getElementById('aiProviderSelect').value = s.AI_PROVIDER || 'ollama';
                    document.getElementById('geminiApiKey').value = s.GEMINI_API_KEY || '';
                    document.getElementById('openaiApiKey').value = s.OPENAI_API_KEY || '';
                    toggleAIFields();
                }
            } catch (err) {
                console.error("Error cargando settings de IA:", err);
            }
        }

        function toggleAIFields() {
            const provider = document.getElementById('aiProviderSelect').value;
            const container = document.getElementById('aiKeysContainer');
            const gBox = document.getElementById('geminiKeyBox');
            const oBox = document.getElementById('openaiKeyBox');

            if (provider === 'ollama') {
                container.style.display = 'none';
            } else {
                container.style.display = 'grid';
                gBox.style.display = (provider === 'gemini') ? 'block' : 'none';
                oBox.style.display = (provider === 'openai') ? 'block' : 'none';
            }
        }

        async function saveAISettings() {
            const statusDiv = document.getElementById('aiSaveStatus');
            statusDiv.innerHTML = '‚è≥ Guardando configuraci√≥n de IA...';
            statusDiv.style.color = '#818cf8';

            const payload = {
                AI_PROVIDER: document.getElementById('aiProviderSelect').value,
                GEMINI_API_KEY: document.getElementById('geminiApiKey').value,
                OPENAI_API_KEY: document.getElementById('openaiApiKey').value
            };

            try {
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                if (data.status === 'success') {
                    statusDiv.innerHTML = '‚úÖ Configuraci√≥n de IA guardada. Los pr√≥ximos an√°lisis usar√°n esta selecci√≥n.';
                    statusDiv.style.color = '#a78bfa';
                    setTimeout(() => statusDiv.innerHTML = '', 5000);
                } else {
                    statusDiv.innerHTML = '‚ùå Error: ' + data.message;
                    statusDiv.style.color = '#f87171';
                }
            } catch (err) {
                statusDiv.innerHTML = '‚ùå Error al guardar: ' + err.message;
                statusDiv.style.color = '#f87171';
            }
        }

        // Cargar al inicio
        loadPatterns();
        loadLogs();
        loadAISettings();
    </script>
</body>

</html>